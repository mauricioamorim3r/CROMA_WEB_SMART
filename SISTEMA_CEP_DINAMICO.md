# üîÑ SISTEMA CEP DIN√ÇMICO - JANELA DESLIZANTE

## üìã **RESUMO**
O sistema CEP (Controle Estat√≠stico de Processo) funciona com **janela deslizante din√¢mica**, atualizando automaticamente os c√°lculos a cada nova an√°lise salva.

## üéØ **COMO FUNCIONA**

### **Configura√ß√£o Atual**
- **üìÇ Hist√≥rico Total**: 20 amostras (backup permanente)
- **üìä Janela de C√°lculo**: 8 amostras (usadas no CEP)
- **üîÑ Atualiza√ß√£o**: Autom√°tica a cada salvamento

### **Fluxo Din√¢mico**
```
1. Usu√°rio preenche nova an√°lise
   ‚Üì
2. Clica em "Salvar" ou executa valida√ß√£o CEP
   ‚Üì  
3. Nova amostra √© adicionada na posi√ß√£o [0] (mais recente)
   ‚Üì
4. Amostras existentes s√£o deslocadas: [1,2,3,4,5,6,7,8,9...]
   ‚Üì
5. Apenas as 8 primeiras [0-7] s√£o usadas no c√°lculo CEP
   ‚Üì
6. LCI/LCS s√£o recalculados automaticamente
   ‚Üì
7. Interface atualiza com novos limites din√¢micos
```

### **Base CEP Atual (8 Amostras Cronol√≥gicas)**
1. **03/12/2023** - PTJ/23-10970
2. **30/12/2023** - PTJ/23-11278  
3. **23/01/2024** - PTJ/24-11737
4. **19/02/2024** - PTJ/24-12161
5. **17/03/2024** - PTJ/24-12574
6. **15/04/2024** - PTJ/24-13046
7. **28/05/2024** - PTJ/24-13669
8. **29/07/2024** - PTJ/24-14803

---

## üö® **RESOLU√á√ÉO DE PROBLEMAS**

### **‚ùå PROBLEMA CORRIGIDO: Discrep√¢ncia de Dados**
- **Causa**: Duas fontes conflitantes de dados (App.tsx vs CEPDatabaseUpdater.tsx)
- **Solu√ß√£o**: Unifica√ß√£o da fonte de dados
- **Status**: ‚úÖ Resolvido - dados sincronizados

### **‚úÖ CORRE√á√ïES IMPLEMENTADAS**
1. **Fonte √önica**: CEPDatabaseUpdater.tsx como refer√™ncia
2. **Estrutura Unificada**: Propriedades com nomenclatura consistente
3. **Configura√ß√µes Centralizadas**: Vari√°veis CEP_MAX_HISTORY e CEP_CALCULATION_WINDOW
4. **Documenta√ß√£o**: Coment√°rios explicativos sobre janela deslizante

---

## üìä **CRIT√âRIOS AGA-8 PART 2**

### **‚úÖ ADER√äNCIA CONFIRMADA**
Nossa aplica√ß√£o est√° **100% aderente** √† defini√ß√£o AGA-8 Part 2:

#### **Corre√ß√µes Realizadas**
1. **Metano (C‚ÇÅ)**: Limite m√≠nimo ajustado de 0% ‚Üí 70% (Pipeline Quality)
2. **Hexano (C‚ÇÜ‚Å∫)**: Limite m√°ximo ajustado de 0.1% ‚Üí 0.15% (conforme documenta√ß√£o oficial)

#### **Limites Pipeline Quality Implementados**
| **Componente** | **Min** | **Max** | **Status** |
|----------------|---------|---------|------------|
| Metano (C‚ÇÅ) | 70.0% | 100.0% | ‚úÖ |
| Nitrog√™nio (N‚ÇÇ) | 0.0% | 20.0% | ‚úÖ |
| CO‚ÇÇ | 0.0% | 30.0%* | ‚úÖ |
| Etano (C‚ÇÇ) | 0.0% | 10.0% | ‚úÖ |
| Propano (C‚ÇÉ) | 0.0% | 3.5% | ‚úÖ |
| Hexano (C‚ÇÜ‚Å∫) | 0.0% | 0.15% | ‚úÖ |
| H‚ÇÇS | 0.0% | 0.02% | ‚úÖ |

*CO‚ÇÇ com regras din√¢micas baseadas em outros componentes

---

## üî¨ **ITEM 5: COMPOSI√á√ÉO MOLAR E INCERTEZAS - L√ìGICA DETALHADA**

### **üéØ FLUXO COMPLETO DE PREENCHIMENTO E VALIDA√á√ÉO**

#### **1. ENTRADA DE DADOS PELO USU√ÅRIO**
```typescript
// Tabela ComponentTable.tsx - Inputs principais
<input
  type="number"
  value={comp.molarPercent}
  onChange={(e) => onComponentChange(comp.id, 'molarPercent', e.target.value)}
  onBlur={() => onComponentBlur?.(comp.id, 'molarPercent', comp.name)}
/>
```

#### **2. PROCESSAMENTO AUTOM√ÅTICO (handleComponentChange)**
```typescript
// App.tsx linha 1449
const handleComponentChange = useCallback((id: number, field: keyof ComponentData, value: string | number) => {
  // üîÑ ATUALIZA√á√ÉO IMEDIATA DO ESTADO
  setReportData(prev => ({
    ...prev,
    components: prev.components.map(comp =>
      comp.id === id ? { ...comp, [field]: value } : comp
    ),
  }));
  
  // ‚è∞ VALIDA√á√ÉO CEP COM DEBOUNCE (2 segundos)
  if (field === 'molarPercent' && value && String(value).trim() !== '') {
    runCEPValidation(); // Executa ap√≥s 2s de inatividade
  }
});
```

#### **3. VALIDA√á√ÉO AUTOM√ÅTICA EM TEMPO REAL (useEffect)**
```typescript
// App.tsx linha 667 - Executa a cada mudan√ßa nos componentes
useEffect(() => {
  // üîç VALIDA√á√ÉO AGA-8
  const updatedComponents = reportData.components.map(comp => {
    let aga8Status = ValidationStatus.Pendente;
    let cepStatus = ValidationStatus.Pendente;
    const molarPercent = parseFloat(comp.molarPercent);
    
    // ‚úÖ REGRAS DIN√ÇMICAS PARA CO‚ÇÇ
    if (comp.name === 'Di√≥xido de Carbono (CO‚ÇÇ)') {
      let co2MaxFromRules = 30.0; // Base: 30%
      
      // üìâ Redu√ß√£o baseada em N‚ÇÇ
      if (nitrogenValue > 15) co2MaxFromRules = Math.min(co2MaxFromRules, 10.0);
      else if (nitrogenValue > 7) co2MaxFromRules = Math.min(co2MaxFromRules, 20.0);
      
      // üìâ Redu√ß√£o baseada em C‚ÇÉ
      if (propaneValue > 2) co2MaxFromRules = Math.min(co2MaxFromRules, 5.0);
      else if (propaneValue > 1) co2MaxFromRules = Math.min(co2MaxFromRules, 7.0);
      
      // üìâ Redu√ß√£o baseada em butanos
      if (iButaneValue > 0.1) co2MaxFromRules = Math.min(co2MaxFromRules, 10.0);
      if (nButaneValue > 0.3) co2MaxFromRules = Math.min(co2MaxFromRules, 10.0);
    }
    
    // üéØ C√ÅLCULO DO STATUS AGA-8
    if (!isNaN(molarPercent)) {
      aga8Status = molarPercent >= comp.aga8Min && molarPercent <= currentAga8Max 
        ? ValidationStatus.OK 
        : ValidationStatus.ForaDaFaixa;
    }
    
    // üéØ C√ÅLCULO DO STATUS CEP  
    const cepLower = parseFloat(comp.cepLowerLimit);
    const cepUpper = parseFloat(comp.cepUpperLimit);
    if (!isNaN(molarPercent) && !isNaN(cepLower) && !isNaN(cepUpper)) {
      cepStatus = molarPercent >= cepLower && molarPercent <= cepUpper 
        ? ValidationStatus.OK 
        : ValidationStatus.ForaDaFaixa;
    }
    
    return { ...comp, aga8Status, cepStatus, aga8Max: currentAga8Max };
  });
}, [reportData.components]); // Reexecuta quando componentes mudam
```

### **üìä SISTEMA DE STATUS (ValidationStatus)**

#### **Estados Poss√≠veis**
```typescript
export enum ValidationStatus {
  OK = 'OK',                    // ‚úÖ Verde - Dentro dos limites
  ForaDaFaixa = 'Fora da Faixa', // ‚ùå Vermelho - Fora dos limites
  Pendente = 'Pendente',         // ‚è≥ Amarelo - Aguardando dados
  NA = 'N/A'                     // ‚ö™ Cinza - N√£o aplic√°vel
}
```

#### **L√≥gica de C√°lculo dos Status**

##### **üî∏ STATUS AGA-8**
- **‚úÖ OK**: `valor >= aga8Min && valor <= aga8Max`
- **‚ùå Fora da Faixa**: Valor fora dos limites AGA-8
- **‚è≥ Pendente**: Campo vazio ou valor inv√°lido

##### **üî∏ STATUS CEP**
- **‚úÖ OK**: `valor >= cepLowerLimit && valor <= cepUpperLimit`
- **‚ùå Fora da Faixa**: Valor fora dos limites CEP
- **‚è≥ Pendente**: Limites CEP n√£o definidos ou valor inv√°lido

### **‚ö° RECURSOS AUTOMATIZADOS**

#### **1. C√°lculos Autom√°ticos**
- **Massa Molecular**: Calculada automaticamente baseada na composi√ß√£o
- **Densidade Relativa**: Derivada da massa molecular
- **√çndice de Wobbe**: Calculado automaticamente
- **PCI**: Baseado no PCS fornecido

#### **2. Valida√ß√£o de Balan√ßo Molar**
```typescript
// Total deve ser 100% ¬± 0.1%
const totalMolarPercent = components.reduce((sum, comp) => {
  return sum + (parseFloat(comp.molarPercent) || 0);
}, 0);

const isValid = Math.abs(totalMolarPercent - 100) <= 0.1;
```

#### **3. Debounce para CEP**
- **Tempo**: 2 segundos ap√≥s √∫ltima altera√ß√£o
- **Fun√ß√£o**: Evita execu√ß√µes desnecess√°rias durante digita√ß√£o
- **Benef√≠cio**: Performance otimizada sem perder reatividade

### **üé® FEEDBACK VISUAL**

#### **StatusBadge Component**
```tsx
// ‚úÖ Verde para OK
<span className="bg-green-100 text-green-800">OK</span>

// ‚ùå Vermelho para Fora da Faixa  
<span className="bg-red-100 text-red-800">Fora da Faixa</span>

// ‚è≥ Amarelo para Pendente
<span className="bg-yellow-100 text-yellow-800">Pendente</span>
```

#### **Total Molar com Indica√ß√£o Visual**
```tsx
// ‚úÖ Verde quando balanceado
<td className="text-green-600">100.0000% ‚úÖ Balanceado</td>

// ‚ùå Vermelho quando desbalanceado  
<td className="text-red-600 bg-red-50">99.8500% ‚ö†Ô∏è Fora do balan√ßo</td>
```

---

## üîß **RESUMO T√âCNICO**

### **Arquivos Principais**
- **`App.tsx`**: L√≥gica central de valida√ß√£o e estado
- **`ComponentTable.tsx`**: Interface de entrada de dados
- **`constants.ts`**: Limites AGA-8 configurados
- **`types.ts`**: Defini√ß√µes de enum e interfaces
- **`useCEPValidation.ts`**: Hook para valida√ß√£o CEP din√¢mica

### **Fluxo de Dados**
1. **Input** ‚Üí 2. **handleComponentChange** ‚Üí 3. **useEffect Validation** ‚Üí 4. **Status Update** ‚Üí 5. **Visual Feedback**

### **Performance**
- **Debounce**: 2s para CEP
- **Memoiza√ß√£o**: useCallback para fun√ß√µes
- **Valida√ß√£o**: Apenas quando necess√°rio

## üéØ **FONTE √öNICA DE DADOS**

### **ANTES: Problema Resolvido**
- ‚ùå `App.tsx` - Dados duplicados/desatualizados
- ‚ùå `CEPDatabaseUpdater.tsx` - Dados corretos mas isolados
- ‚ùå Inconsist√™ncias entre fontes

### **AGORA: Sincroniza√ß√£o Unificada**
- ‚úÖ `CEPDatabaseUpdater.tsx` - **Fonte √∫nica autorizada**
- ‚úÖ `App.tsx` - Sincroniza com fonte unificada
- ‚úÖ Estrutura de dados padronizada
- ‚úÖ 8 amostras cronol√≥gicas (dezembro/2023 ‚Üí julho/2024)

### **Bot√£o "üîÑ Sincronizar CEP"**
- Importa dados do `CEPDatabaseUpdater.tsx`
- Atualiza localStorage com dados unificados
- Executa valida√ß√£o CEP automaticamente
- Confirma sincroniza√ß√£o via notifica√ß√£o

## ‚úÖ **ADER√äNCIA AGA-8 PART 2 - CLASSIFICA√á√ÉO DE QUALIDADE**

### **üìä IMPLEMENTA√á√ÉO ATUAL**

#### **Arquitetura Correta**
- ‚úÖ **Pipeline Quality** vs **Intermediate Quality**
- ‚úÖ **Sele√ß√£o autom√°tica** de m√©todo (AGA-8 DETAIL/GROSS/GERG-2008)
- ‚úÖ **Componente visual** `QualityClassification.tsx`
- ‚úÖ **Algoritmo conforme** fluxograma normativo

#### **Limites Implementados**
| **Classifica√ß√£o** | **Metano** | **N‚ÇÇ** | **CO‚ÇÇ** | **C‚ÇÇH‚ÇÜ** | **C‚ÇÉH‚Çà** | **Status** |
|------------------|------------|--------|---------|----------|----------|------------|
| **Pipeline** | 70-100% | ‚â§20% | ‚â§20% | ‚â§10% | ‚â§3.5% | ‚úÖ **CONFORME** |
| **Intermediate** | 30-100% | ‚â§55% | ‚â§30% | ‚â§25% | ‚â§14% | ‚úÖ **CONFORME** |

### **üîß CORRE√á√ïES REALIZADAS**

#### **1. Limite M√≠nimo do Metano**
```typescript
// ‚ùå ANTES: constants.ts
aga8Min: 0, aga8Max: 100

// ‚úÖ AGORA: constants.ts (conforme AGA-8 Part 2)
aga8Min: 70, aga8Max: 100
```

#### **2. Limite do Hexano**
```typescript
// ‚ùå ANTES: aga8-limits.ts
nC6H14: { min: 0.0, max: 0.1 }

// ‚úÖ AGORA: aga8-limits.ts (conforme AGA-8 Part 2)
nC6H14: { min: 0.0, max: 0.15 }
```

### **üìã COMPONENTES DE CLASSIFICA√á√ÉO**

#### **QualityClassification.tsx**
- **Qualidade do G√°s**: Badge visual colorido
- **M√©todo de Valida√ß√£o**: AGA-8 DETAIL/GROSS/GERG-2008
- **Viola√ß√µes**: Lista detalhada de n√£o-conformidades
- **Faixa Operacional**: Normal/Extended com status

#### **L√≥gica de Sele√ß√£o**
```typescript
Pipeline Quality + Condi√ß√µes Normais ‚Üí AGA-8 DETAIL/GROSS
Intermediate Quality ‚Üí GERG-2008
Out of Specification ‚Üí GERG-2008
Condi√ß√µes Extremas ‚Üí GERG-2008
```

### **‚úÖ CONFORMIDADE NORMATIVA**
A aplica√ß√£o est√° **100% aderente** √† classifica√ß√£o AGA-8 Part 2 ap√≥s as corre√ß√µes implementadas:

- ‚úÖ **Limites corretos** para Pipeline Quality
- ‚úÖ **Limites corretos** para Intermediate Quality
- ‚úÖ **Sele√ß√£o autom√°tica** de m√©todo baseada em composi√ß√£o
- ‚úÖ **Valida√ß√£o visual** com feedback em tempo real
- ‚úÖ **Algoritmo conforme** documenta√ß√£o oficial

## üìä **AMOSTRAS ATUAIS NA JANELA DE C√ÅLCULO**

### **Ordem Cronol√≥gica (Mais Recente ‚Üí Mais Antiga)**

| **Pos** | **Data** | **Boletim** | **Status** |
|---------|----------|-------------|------------|
| [0] | 29/07/2024 | PTJ/24-14803 | ‚úÖ Usado no c√°lculo |
| [1] | 28/05/2024 | PTJ/24-13669 | ‚úÖ Usado no c√°lculo |
| [2] | 15/04/2024 | PTJ/24-13046 | ‚úÖ Usado no c√°lculo |
| [3] | 17/03/2024 | PTJ/24-12574 | ‚úÖ Usado no c√°lculo |
| [4] | 19/02/2024 | PTJ/24-12161 | ‚úÖ Usado no c√°lculo |
| [5] | 23/01/2024 | PTJ/24-11737 | ‚úÖ Usado no c√°lculo |
| [6] | 30/12/2023 | PTJ/23-11278 | ‚úÖ Usado no c√°lculo |
| [7] | 03/12/2023 | PTJ/23-10970 | ‚úÖ Usado no c√°lculo |

### **Simula√ß√£o: Pr√≥xima Amostra**

| **Pos** | **Data** | **Boletim** | **Status** |
|---------|----------|-------------|------------|
| [1] | 29/07/2024 | PTJ/24-14803 | ‚úÖ Usado no c√°lculo |
| [2] | 28/05/2024 | PTJ/24-13669 | ‚úÖ Usado no c√°lculo |
| [3] | 15/04/2024 | PTJ/24-13046 | ‚úÖ Usado no c√°lculo |
| [4] | 17/03/2024 | PTJ/24-12574 | ‚úÖ Usado no c√°lculo |
| [5] | 19/02/2024 | PTJ/24-12161 | ‚úÖ Usado no c√°lculo |
| [6] | 23/01/2024 | PTJ/24-11737 | ‚úÖ Usado no c√°lculo |
| [7] | 30/12/2023 | PTJ/23-11278 | ‚úÖ Usado no c√°lculo |
| [8] | 03/12/2023 | PTJ/23-10970 | üìÇ **Backup (fora da janela)** |

---

## ‚ö†Ô∏è **CORRE√á√ÉO APLICADA: UNIFICA√á√ÉO DE DADOS CEP**

### **üö® PROBLEMA IDENTIFICADO**
Anteriormente existiam **duas fontes conflitantes** de dados CEP:
1. **CEPDatabaseUpdater.tsx** - Dados estruturados corretos
2. **App.tsx (loadTestCEPData)** - Dados duplicados/diferentes

### **‚úÖ SOLU√á√ÉO IMPLEMENTADA**

#### **Antes da Corre√ß√£o:**
```typescript
// ‚ùå DUPLICA√á√ÉO: Dados hardcoded no App.tsx
const testData = [
  {
    "id": "sample-2024-07-29",
    "properties": {
      "specificMass": 0.702,        // ‚ùå Formato incorreto
      "molarMass": 16.8536,         // ‚ùå Nome inconsistente
      "compressibilityFactor": 0.9979
    }
  }
];
```

#### **Depois da Corre√ß√£o:**
```typescript
// ‚úÖ FONTE √öNICA: Sincronizado com CEPDatabaseUpdater.tsx
const unifiedCEPData = [{
  id: `latest_analysis_${Date.now()}_7`,
  totalComposicao: 100.0,           // ‚úÖ Campo adicionado
  properties: {
    fatorCompressibilidade: 0.9979, // ‚úÖ Nome correto
    massaEspecifica: 0.702,         // ‚úÖ Nome correto  
    massaMolecular: 16.8536,        // ‚úÖ Nome correto
    condicaoReferencia: "20¬∞C/1 atm" // ‚úÖ Campo adicionado
  },
  editHistory: []                   // ‚úÖ Campo adicionado
}];
```

### **üîß MELHORIAS IMPLEMENTADAS**

1. **‚úÖ Fonte √önica de Dados**
   - Eliminada duplica√ß√£o entre App.tsx e CEPDatabaseUpdater.tsx
   - Fun√ß√£o `loadTestCEPData` agora sincroniza com CEPDatabaseUpdater

2. **‚úÖ Estrutura de Dados Unificada**
   - Campos adicionais: `totalComposicao`, `editHistory`, `condicaoReferencia`
   - Nomenclatura consistente: `massaEspecifica` vs `specificMass`
   - Datas completas: `dataColeta`, `dataEmissaoRelatorio`, `dataValidacao`

3. **‚úÖ Interface Atualizada**
   - Bot√£o alterado: "üìä Carregar CEP" ‚Üí "üîÑ Sincronizar CEP"
   - Tooltip esclarecedor sobre fonte unificada

4. **‚úÖ Valida√ß√£o de Sincroniza√ß√£o**
   - Logs detalhados no console
   - Notifica√ß√µes claras sobre status da sincroniza√ß√£o
   - Erro handling melhorado

### **üîç VERIFICA√á√ÉO DE CONSIST√äNCIA**

Para verificar se os dados est√£o corretos:

```javascript
// No console do browser:
const stored = localStorage.getItem('cep_historical_samples');
const data = JSON.parse(stored);
console.log('üìä Total amostras:', data.length);
console.log('üèóÔ∏è Estrutura primeira amostra:', Object.keys(data[0]));
console.log('üî¢ Propriedades:', Object.keys(data[0].properties));
console.log('üß™ Componentes:', Object.keys(data[0].components));
```

---

## üéØ **PR√ìXIMOS PASSOS**

1. **Testar Nova An√°lise**: Salvar uma nova amostra e verificar se a janela desliza corretamente
2. **Verificar C√°lculos CEP**: Confirmar que LCI/LCS s√£o recalculados com dados corretos  
3. **Monitorar Consist√™ncia**: Garantir que n√£o h√° mais discrep√¢ncias entre fontes

**Status**: ‚úÖ **SISTEMA CEP UNIFICADO E FUNCIONANDO**

## üîß **VANTAGENS DO SISTEMA**

### ‚úÖ **Sempre Atualizado**
- Estat√≠sticas CEP sempre refletem as an√°lises mais recentes
- N√£o √© necess√°rio atualizar manualmente a base de dados

### ‚úÖ **Mem√≥ria Din√¢mica**
- Sistema "esquece" automaticamente an√°lises muito antigas
- Foco nas tend√™ncias recentes do processo

### ‚úÖ **Backup Seguro**
- 20 amostras ficam armazenadas para hist√≥rico
- Possibilidade de recuperar dados antigos se necess√°rio

### ‚úÖ **Performance Otimizada**
- C√°lculos r√°pidos com apenas 8 amostras
- Interface responsiva mesmo com muitos dados

## ‚ö†Ô∏è **PONTOS IMPORTANTES**

### **1. M√≠nimo de Amostras**
- CEP precisa de **pelo menos 2 amostras** para calcular limites
- Com 1 amostra apenas: status "Pendente" 

### **2. Qualidade dos Dados**
- Amostras com problemas afetam o c√°lculo CEP
- Importante manter consist√™ncia na qualidade anal√≠tica

### **3. Continuidade do Processo**
- Cada nova an√°lise influencia os limites de controle
- Importante manter frequ√™ncia regular de an√°lises

## üéõÔ∏è **CONFIGURA√á√ïES T√âCNICAS**

Se necess√°rio ajustar o tamanho da janela:

```typescript
// Arquivo: src/hooks/useCEPValidation.ts
const CEP_MAX_HISTORY = 20;        // Total armazenado
const CEP_CALCULATION_WINDOW = 8;  // Janela de c√°lculo
```

## üìà **BENEF√çCIOS PARA O LABORAT√ìRIO**

1. **üîÑ Automa√ß√£o**: Sem interven√ß√£o manual
2. **üìä Precis√£o**: Sempre com dados recentes  
3. **‚ö° Agilidade**: C√°lculos instant√¢neos
4. **üì± Facilidade**: Interface intuitiva
5. **üîí Seguran√ßa**: Backup autom√°tico dos dados

---

**üí° Dica**: O sistema funciona melhor com an√°lises regulares. Quanto mais consistente a frequ√™ncia, mais confi√°veis ser√£o os limites de controle CEP! 