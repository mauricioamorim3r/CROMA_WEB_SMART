import * as Sentry from '@sentry/react';

// ConfiguraÃ§Ã£o segura do Sentry
export const sentryConfig = {
  // Busca a DSN das variÃ¡veis de ambiente
  dsn: (import.meta as any).env?.VITE_SENTRY_DSN || '',
  
  // ConfiguraÃ§Ãµes baseadas no ambiente
  environment: (import.meta as any).env?.VITE_SENTRY_ENVIRONMENT || 'development',
  
  // Taxa de amostragem (0.0 a 1.0)
  sampleRate: parseFloat((import.meta as any).env?.VITE_SENTRY_SAMPLE_RATE || '1.0'),
  
  // ConfiguraÃ§Ãµes de performance
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  
  // ConfiguraÃ§Ãµes de release
  release: (import.meta as any).env?.VITE_APP_VERSION || '1.0.0',
  
  // ConfiguraÃ§Ãµes especÃ­ficas da aplicaÃ§Ã£o
  beforeSend(event: any) {
    // Filtrar informaÃ§Ãµes sensÃ­veis
    if (event.exception) {
      const error = event.exception.values?.[0];
      if (error && error.stacktrace) {
        // Remove paths absolutos que podem revelar estrutura do sistema
        error.stacktrace.frames?.forEach((frame: any) => {
          if (frame.filename) {
            frame.filename = frame.filename.replace(/^.*[\\\/]/, '');
          }
        });
      }
    }
    return event;
  },
  
  // Tags personalizadas
  initialScope: {
    tags: {
      app: 'validador-cromatografia',
      platform: 'electron-react'
    },
    user: {
      // NÃ£o incluir informaÃ§Ãµes pessoais por padrÃ£o
      id: 'anonymous'
    }
  }
};

// ValidaÃ§Ã£o da configuraÃ§Ã£o
export const isSentryConfigValid = (): boolean => {
  if (!sentryConfig.dsn) {
    console.warn('âš ï¸  SENTRY_DSN nÃ£o encontrada nas variÃ¡veis de ambiente');
    return false;
  }
  
  if (!sentryConfig.dsn.startsWith('https://')) {
    console.error('âŒ SENTRY_DSN invÃ¡lida');
    return false;
  }
  
  return true;
};

// InicializaÃ§Ã£o do Sentry
export const initSentry = (): boolean => {
  if (!isSentryConfigValid()) {
    console.warn('âš ï¸ Sentry nÃ£o inicializado - configuraÃ§Ã£o invÃ¡lida');
    return false;
  }
  
  try {
    Sentry.init(sentryConfig);
    console.log('âœ… Sentry inicializado com sucesso');
    logSentryStatus();
    return true;
  } catch (error) {
    console.error('âŒ Erro ao inicializar Sentry:', error);
    return false;
  }
};

// Log de status da configuraÃ§Ã£o
export const logSentryStatus = (): void => {
  console.group('ğŸ” Status do Sentry');
  console.log(`ğŸ·ï¸  Ambiente: ${sentryConfig.environment}`);
  console.log(`ğŸ“Š Sample Rate: ${sentryConfig.sampleRate}`);
  console.log(`ğŸš€ Release: ${sentryConfig.release}`);
  console.log(`ğŸ”— DSN configurada: ${sentryConfig.dsn ? 'âœ…' : 'âŒ'}`);
  console.groupEnd();
};

// Utilities para captura de erros
export const captureError = (error: Error, context?: any) => {
  Sentry.captureException(error, { extra: context });
};

export const captureMessage = (message: string, level: Sentry.SeverityLevel = 'info') => {
  Sentry.captureMessage(message, level);
};

export const addBreadcrumb = (message: string, category: string = 'custom') => {
  Sentry.addBreadcrumb({
    message,
    category,
    level: 'info',
    timestamp: Date.now() / 1000,
  });
};

export const setUser = (user: { id?: string; email?: string; username?: string }) => {
  Sentry.setUser(user);
};

export const setTag = (key: string, value: string) => {
  Sentry.setTag(key, value);
}; 